<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Biskuit ceramics</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tilda+Sans:wght@300;400;500;600;700&display=swap');

    :root {
      --color-cream: #fdfaf6;
      --color-cream-dark: #f5f1ed;
      --color-brown: #6b5d52;
      --color-brown-light: #8d7d70;
      --color-brown-dark: #4a3f36;
      --color-black: #333333;
      --color-accent: #ff7000;
      --font-serif: 'Tilda Sans', -apple-system, sans-serif;
      --font-sans: 'Tilda Sans', -apple-system, sans-serif;
      --color-background: var(--color-cream);
      --color-surface: #ffffff;
      --color-text: var(--color-black);
      --color-text-secondary: var(--color-brown);
      --color-primary: var(--color-brown);
      --color-primary-hover: var(--color-brown-dark);
      --color-border: rgba(107, 93, 82, 0.15);
      --color-card-border: rgba(107, 93, 82, 0.1);
      --radius-base: 2px;
      --radius-lg: 4px;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.03);
      --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-sans);
      background: var(--color-background);
      color: var(--color-text);
      line-height: 1.6;
      font-size: 18px;
    }

    .page-wrapper {
      display: flex;
      min-height: 100vh;
    }

    .main-content {
      flex: 1;
      padding: 40px;
      max-width: calc(100% - 320px);
    }

    .sidebar {
      width: 320px;
      background: var(--color-surface);
      border-left: 1px solid var(--color-border);
      padding: 40px 30px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }

    h1 {
      font-family: var(--font-serif);
      font-size: 48px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--color-text);
      letter-spacing: 0;
    }

    .subtitle {
      font-family: var(--font-sans);
      font-size: 15px;
      color: var(--color-text-secondary);
      margin-bottom: 50px;
      font-weight: 300;
    }

    .sidebar-title {
      font-family: var(--font-serif);
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 30px;
      color: var(--color-text);
      letter-spacing: 0;
    }

    .filter-section {
      margin-bottom: 35px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    label {
      font-size: 13px;
      font-weight: 500;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    select,
    input {
      padding: 12px 14px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      background: var(--color-background);
      color: var(--color-text);
      font-size: 15px;
      font-family: var(--font-sans);
      transition: all 0.2s ease;
    }

    select:hover,
    input:hover {
      border-color: var(--color-primary);
    }

    select:focus,
    input:focus {
      outline: none;
      border-color: var(--color-primary);
      background: var(--color-surface);
    }

    .stats {
      font-size: 13px;
      color: var(--color-text-secondary);
      margin-top: 30px;
      padding-top: 30px;
      border-top: 1px solid var(--color-border);
      font-weight: 300;
    }

    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 40px 30px;
      margin-bottom: 60px;
    }

    .product-card {
      background: var(--color-surface);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .product-card:hover {
      opacity: 0.85;
    }

    .product-image {
      width: 100%;
      aspect-ratio: 4/5;
      object-fit: cover;
      background: linear-gradient(90deg, var(--color-cream-dark) 25%, #f0ebe5 50%, var(--color-cream-dark) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      display: block;
    }

    .product-image.loaded {
      animation: none;
      background: var(--color-cream-dark);
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    .product-info {
      padding: 20px 0;
    }

    .product-title {
      font-family: var(--font-serif);
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--color-text);
      line-height: 1.3;
    }

    .product-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 18px;
      color: var(--color-text-secondary);
      margin-bottom: 12px;
      font-weight: 600;
    }

    .product-price {
      font-family: var(--font-sans);
      font-size: 28px;
      font-weight: 700;
      color: var(--color-text);
    }

    .product-price-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .product-price-old {
      font-size: 14px;
      color: var(--color-text-secondary);
      text-decoration: line-through;
      font-weight: 400;
    }

    .product-discount-badge {
      background: var(--color-accent);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--color-surface);
      border-radius: 12px;
      max-width: 1100px;
      width: 95%;
      max-height: 92vh;
      overflow: hidden;
      position: relative;
      display: grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 0;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 26px;
      line-height: 1;
      z-index: 100;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: rgba(0, 0, 0, 0.8);
      transform: scale(1.05);
    }

    .modal-left {
      background: var(--color-cream-dark);
      padding: 50px 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .modal-image-main {
      width: 100%;
      max-width: 500px;
      min-height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: linear-gradient(90deg, #f5f1ed 25%, #f0ebe5 50%, #f5f1ed 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    .modal-image-main.loaded {
      animation: none;
      background: white;
    }

    .modal-image {
      max-width: 100%;
      max-height: 500px;
      object-fit: contain;
      display: none;
    }

    .modal-image.active {
      display: block;
    }

    .modal-thumbnails {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .modal-thumbnail {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s ease;
      background: white;
    }

    .modal-thumbnail:hover {
      border-color: var(--color-accent);
    }

    .modal-thumbnail.active {
      border-color: var(--color-brown);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .modal-right {
      padding: 50px 45px;
      overflow-y: auto;
      background: var(--color-surface);
    }

    .modal-title {
      font-family: var(--font-serif);
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--color-text);
      line-height: 1.2;
    }

    .modal-code {
      font-size: 13px;
      color: var(--color-brown-light);
      margin-bottom: 24px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .modal-price {
      font-family: var(--font-sans);
      font-size: 38px;
      font-weight: 700;
      color: var(--color-accent);
      margin-bottom: 32px;
      letter-spacing: -0.02em;
    }

    .modal-section {
      margin-bottom: 28px;
    }

    .modal-section-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--color-brown-light);
      margin-bottom: 12px;
    }

    .modal-details {
      display: grid;
      gap: 10px;
    }

    .detail-row {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 12px;
      font-size: 15px;
      padding: 8px 0;
      border-bottom: 1px solid var(--color-border);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 500;
      color: var(--color-text-secondary);
    }

    .detail-value {
      color: var(--color-text);
      font-weight: 400;
    }

    .modal-description {
      font-size: 15px;
      line-height: 1.7;
      color: var(--color-text-secondary);
      margin-bottom: 32px;
    }

    .modal-cta {
      width: 100%;
      padding: 16px 32px;
      background: var(--color-accent);
      color: white;
      border: none;
      border-radius: var(--radius-base);
      font-family: var(--font-sans);
      font-size: 16px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
    }

    .modal-cta:hover {
      background: #e56a00;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .image-nav,
    .image-indicators {
      display: none;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      font-size: 18px;
      color: var(--color-text-secondary);
    }

    .empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--color-text-secondary);
    }

    .empty h2 {
      font-size: 20px;
      margin-bottom: 10px;
    }

    @media (max-width: 1024px) {
      .page-wrapper {
        flex-direction: column;
      }

      .main-content {
        max-width: 100%;
        padding: 30px 20px;
      }

      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        border-left: none;
        border-top: 1px solid var(--color-border);
        padding: 30px 20px;
      }

      h1 {
        font-size: 36px;
      }

      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 30px 20px;
      }
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 32px;
      }

      .gallery {
        grid-template-columns: repeat(2, 1fr);
        gap: 20px 15px;
      }

      .modal-content {
        grid-template-columns: 1fr;
        max-height: 95vh;
        width: 98%;
      }

      .modal-left {
        padding: 30px 20px;
      }

      .modal-right {
        padding: 30px 25px;
      }

      .modal-title {
        font-size: 26px;
      }

      .modal-price {
        font-size: 32px;
      }
    }
  </style>
</head>

<body>
  <div class="page-wrapper">
    <div class="main-content">
      <h1>–ë–∏—Å–∫–≤–∏—Ç</h1>
      <div class="subtitle">–°—Ç—É–¥–∏—è –∫–µ—Ä–∞–º–∏–∫–∏</div>

      <div id="gallery" class="gallery">
        <div class="loading">–ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞–±–æ—Ç—ã...</div>
      </div>
    </div>

    <aside class="sidebar">
      <h2 class="sidebar-title">–§–∏–ª—å—Ç—Ä—ã</h2>

      <div class="filter-section">
        <div class="filter-group">
          <label for="searchInput">–ü–æ–∏—Å–∫</label>
          <input type="text" id="searchInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã..." />
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-group">
          <label for="authorFilter">–ê–≤—Ç–æ—Ä</label>
          <select id="authorFilter">
            <option value="">–í—Å–µ</option>
          </select>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-group">
          <label for="categoryFilter">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select id="categoryFilter">
            <option value="">–í—Å–µ</option>
          </select>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-group">
          <label for="priceMin">–¶–µ–Ω–∞ –æ—Ç</label>
          <input type="number" id="priceMin" placeholder="0" />
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-group">
          <label for="priceMax">–¶–µ–Ω–∞ –¥–æ</label>
          <input type="number" id="priceMax" placeholder="100000" />
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-group">
          <label for="sortSelect">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
          <select id="sortSelect">
            <option value="name-asc">–ê-–Ø</option>
            <option value="name-desc">–Ø-–ê</option>
            <option value="price-asc">–¶–µ–Ω–∞: –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏–µ</option>
            <option value="price-desc">–¶–µ–Ω–∞: —É–±—ã–≤–∞–Ω–∏–µ</option>
            <option value="date-desc">–ù–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏</option>
            <option value="date-asc">–°—Ç–∞—Ä—ã–µ –ø–µ—Ä–≤—ã–º–∏</option>
          </select>
        </div>
      </div>

      <div class="stats">
        <span id="statsText">–ó–∞–≥—Ä—É–∂–∞–µ–º...</span>
      </div>
    </aside>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">√ó</button>

      <div class="modal-left">
        <div class="modal-image-main">
          <div id="modalImagesContainer"></div>
        </div>
        <div class="modal-thumbnails" id="modalThumbnails"></div>
      </div>

      <div class="modal-right">
        <h2 class="modal-title" id="modalTitle"></h2>
        <div class="modal-code" id="modalCode"></div>
        <div class="modal-price" id="modalPrice"></div>

        <div class="modal-section">
          <div class="modal-section-title">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</div>
          <div class="modal-details" id="modalDetails"></div>
        </div>

        <div class="modal-description" id="modalDescription"></div>

        <button class="modal-cta" onclick="orderProduct()">–ó–∞–∫–∞–∑–∞—Ç—å –≤ WhatsApp</button>
      </div>
    </div>
  </div>

  <script>
    // ============ –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï ============
    // –í–º–µ—Å—Ç–æ GitHub –∏—Å–ø–æ–ª—å–∑—É–µ–º Google Apps Script JSON —ç–Ω–¥–ø–æ–∏–Ω—Ç
    const JSON_URL = 'https://script.google.com/macros/s/AKfycbwxVysb3TjXjv7tx0CTjc4ln4lYeGftE-CdAttnROgzbPNoFnQ2RtFv4kUH-kY8c7YwUw/exec';
    // ==========================================

    let allProducts = [];
    let filteredProducts = [];
    let currentImageIndex = 0;
    let currentProduct = null;

    async function loadProducts() {
      try {
        console.log('üì• –ó–∞–≥—Ä—É–∂–∞–µ–º —Å:', JSON_URL);

        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é (–±–µ–∑ CORS)
        let response = await fetch(JSON_URL, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
          },
          cache: 'no-cache',
          mode: 'cors'
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('‚úÖ JSON –∑–∞–≥—Ä—É–∂–µ–Ω:', typeof data, Array.isArray(data) ? 'array' : 'object');

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Google Apps Script
        let works = [];

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª–µ .works (–Ω–∞—à —Ñ–æ—Ä–º–∞—Ç –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞)
        if (data.works && Array.isArray(data.works)) {
          works = data.works;
          console.log('üì¶ –ò—Å–ø–æ–ª—å–∑—É–µ–º data.works');
        }
        // –ò–Ω–∞—á–µ –±–µ—Ä—ë–º —Å–∞–º –º–∞—Å—Å–∏–≤ (–µ—Å–ª–∏ —ç—Ç–æ –º–∞—Å—Å–∏–≤)
        else if (Array.isArray(data)) {
          works = data;
          console.log('üì¶ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∞–º –º–∞—Å—Å–∏–≤');
        }
        // –ü–æ–ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –≤–µ—Ä–æ—è—Ç–Ω—ã–µ –ø–æ–ª—è
        else if (data.record && Array.isArray(data.record)) {
          works = data.record;
        }
        else if (data.products && Array.isArray(data.products)) {
          works = data.products;
        }
        else if (data.items && Array.isArray(data.items)) {
          works = data.items;
        }
        else if (data.data && Array.isArray(data.data)) {
          works = data.data;
        }
        else {
          console.warn('‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON. –ö–ª—é—á–∏:', Object.keys(data));
          works = [];
        }

        console.log(`üìä –ù–∞–π–¥–µ–Ω–æ —Ä–∞–±–æ—Ç: ${works.length}`);

        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        allProducts = works.map((item, index) => {
          // –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π –∏–∑ Google Apps Script JSON
          return {
            title: item.title || item.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
            author: item.author || '–ê–≤—Ç–æ—Ä –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω',
            category: item.category || '–î—Ä—É–≥–æ–µ',
            price: parseFloat(item.price) || 0,
            discount: parseFloat(item.discount) || 0,
            image: item.photo || item.image || '',
            material: item.description || item.material || '',
            size: item.size || '',
            color: item.color || '',
            quantity: parseInt(item.quantity) || 0,
            description: item.description || '',
            date: item.timestamp || new Date().toISOString(),
            sku: `BISKUIT-${index + 1}`
          };
        });

        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã. –ü–µ—Ä–≤–∞—è —Ä–∞–±–æ—Ç–∞:', allProducts[0]);

        populateFilters();
        filterAndSort();

      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        document.getElementById('gallery').innerHTML = `
          <div class="empty">
            <h2>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h2>
            <p><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> ${error.message}</p>
            <p style="margin-top: 15px; font-size: 13px;">
              <strong>–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:</strong><br>
              1. F12 ‚Üí Console (–µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏?)<br>
              2. –û—Ç–∫—Ä–æ–π—Ç–µ <a href="${JSON_URL}" target="_blank" style="color: var(--color-primary);">JSON —Ñ–∞–π–ª</a><br>
              3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –Ω–∞ Google Apps Script —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç<br>
              4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ JSON –≤–µ—Ä–Ω—É–ª—Å—è
            </p>
          </div>
        `;
      }
    }

    function populateFilters() {
      const categories = new Set();
      const authors = new Set();

      allProducts.forEach(product => {
        if (product.category) categories.add(product.category);
        if (product.author) authors.add(product.author);
      });

      const categoryFilter = document.getElementById('categoryFilter');
      const authorFilter = document.getElementById('authorFilter');

      Array.from(categories).sort().forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categoryFilter.appendChild(option);
      });

      Array.from(authors).sort().forEach(author => {
        const option = document.createElement('option');
        option.value = author;
        option.textContent = author;
        authorFilter.appendChild(option);
      });
    }

    function filterAndSort() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const category = document.getElementById('categoryFilter').value;
      const author = document.getElementById('authorFilter').value;
      const priceMin = parseFloat(document.getElementById('priceMin').value) || 0;
      const priceMax = parseFloat(document.getElementById('priceMax').value) || Infinity;
      const sort = document.getElementById('sortSelect').value;

      filteredProducts = allProducts.filter(product => {
        const matchesSearch = !search || 
          product.title.toLowerCase().includes(search) ||
          (product.author && product.author.toLowerCase().includes(search));
        
        const matchesCategory = !category || product.category === category;
        const matchesAuthor = !author || product.author === author;
        
        const price = parseFloat(product.price) || 0;
        const matchesPrice = price >= priceMin && price <= priceMax;

        return matchesSearch && matchesCategory && matchesAuthor && matchesPrice;
      });

      const [sortBy, sortOrder] = sort.split('-');

      filteredProducts.sort((a, b) => {
        let valA, valB;

        if (sortBy === 'name') {
          valA = a.title.toLowerCase();
          valB = b.title.toLowerCase();
        } else if (sortBy === 'price') {
          valA = parseFloat(a.price) || 0;
          valB = parseFloat(b.price) || 0;
        } else if (sortBy === 'date') {
          valA = new Date(a.date || a.created_at || 0).getTime();
          valB = new Date(b.date || b.created_at || 0).getTime();
        }

        if (sortOrder === 'asc') {
          return valA > valB ? 1 : valA < valB ? -1 : 0;
        } else {
          return valA > valB ? -1 : valA < valB ? 1 : 0;
        }
      });

      renderGallery();
      updateStats();
    }

    function renderGallery() {
      const gallery = document.getElementById('gallery');

      if (filteredProducts.length === 0) {
        gallery.innerHTML = `
          <div class="empty">
            <h2>–ù–µ—Ç —Ä–∞–±–æ—Ç</h2>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</p>
          </div>
        `;
        return;
      }

      gallery.innerHTML = filteredProducts.map((product, index) => {
        const title = product.title || product.name;
        const image = getProductImage(product);
        const category = product.category;
        const author = product.author;

        let priceHtml;
        if (product.discount && product.discount > 0) {
          const discountedPrice = Math.round(product.price * (1 - product.discount / 100));
          priceHtml = `
            <div class="product-price-wrapper">
              <div class="product-price">${discountedPrice}</div>
              <div class="product-price-old">${product.price}</div>
              <div class="product-discount-badge">${-product.discount}%</div>
            </div>
          `;
        } else {
          const price = product.price ? product.price : '–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É';
          priceHtml = `<div class="product-price">${price}</div>`;
        }

        return `
          <div class="product-card" onclick="openModal(${index})">
            <img src="${image}" alt="${title}" class="product-image" loading="lazy" 
              onload="this.classList.add('loaded')" 
              onerror="this.classList.add('loaded')"
            />
            <div class="product-info">
              <div class="product-title">${title}</div>
              <div class="product-meta">
                ${author ? `<div>${author}</div>` : ''}
              </div>
              ${priceHtml}
            </div>
          </div>
        `;
      }).join('');
    }

    function getProductImage(product) {
      let img = product.image || product.photo;

      // –ï—Å–ª–∏ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ —ç—Ç–æ —Å—Ç—Ä–∞–Ω–Ω—ã–π URL
      if (!img || !img.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
        if (img && img.match(/IMG[A-F0-9-36]/i)) {
          return convertImageUrl(img);
        }
        // –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
        return `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='500'%3E%3Crect fill='%23f5f1ed' width='400' height='500'/%3E%3C/svg%3E`;
      }

      // Google Drive –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
      if (img.includes('drive.google.com')) {
        if (img.includes('open?id')) {
          const match = img.match(/id=([^&]+)/);
          if (match && match[1]) {
            img = `https://drive.google.com/thumbnail?id=${match[1]}&sz=w400`;
          }
        } else if (img.includes('/d/')) {
          const match = img.match(/\/d\/([^/]+)/);
          if (match && match[1]) {
            img = `https://drive.google.com/thumbnail?id=${match[1]}&sz=w400`;
          }
        } else if (img.includes('uc?id')) {
          const match = img.match(/id=([^&]+)/);
          if (match && match[1]) {
            img = `https://drive.google.com/thumbnail?id=${match[1]}&sz=w400`;
          }
        }
      }

      // VK, userapi –∏ –¥—Ä—É–≥–∏–µ
      if (img.includes('userapi.com')) {
        return img; // –£–∂–µ —Ä–∞–±–æ—Ç–∞—é—â–∏–π URL
      }

      return img;
    }

    function convertImageUrl(url) {
      if (!url) return '';

      // Google Drive –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
      if (url.includes('drive.google.com')) {
        if (url.includes('open?id')) {
          const match = url.match(/id=([^&]+)/);
          if (match && match[1]) {
            return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w400`;
          }
        } else if (url.includes('/d/')) {
          const match = url.match(/\/d\/([^/]+)/);
          if (match && match[1]) {
            return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w400`;
          }
        } else if (url.includes('uc?id')) {
          const match = url.match(/id=([^&]+)/);
          if (match && match[1]) {
            return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w400`;
          }
        }
      }

      return url;
    }

    function getProductImages(product) {
      if (product.images && Array.isArray(product.images)) {
        return product.images.map(img => convertImageUrl(img));
      }
      if (product.photos && Array.isArray(product.photos)) {
        return product.photos.map(img => convertImageUrl(img));
      }
      if (product.image) {
        return [convertImageUrl(product.image)];
      }
      if (product.photo) {
        return [convertImageUrl(product.photo)];
      }
      return [getProductImage(product)];
    }

    function updateStats() {
      const total = allProducts.length;
      const shown = filteredProducts.length;
      document.getElementById('statsText').textContent = `${shown} –∏–∑ ${total}`;
    }

    function openModal(index) {
      currentProduct = filteredProducts[index];
      currentImageIndex = 0;
      const modal = document.getElementById('modal');

      const title = currentProduct.title || currentProduct.name;
      const images = getProductImages(currentProduct);

      let priceText;
      if (currentProduct.discount && currentProduct.discount > 0) {
        const discountedPrice = Math.round(currentProduct.price * (1 - currentProduct.discount / 100));
        priceText = `
          ${discountedPrice}
          <div style="font-size: 18px; color: var(--color-text-secondary); text-decoration: line-through; font-weight: 400; margin-top: 8px;">
            ${currentProduct.price}
          </div>
          <div style="display: inline-block; background: var(--color-accent); color: white; font-size: 14px; padding: 4px 10px; border-radius: 4px; margin-top: 12px;">
            ${-currentProduct.discount}%
          </div>
        `;
      } else {
        priceText = currentProduct.price ? currentProduct.price : '–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É';
      }

      document.getElementById('modalPrice').innerHTML = priceText;
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalCode').textContent = `${currentProduct.sku || 'BISKUIT-' + (index + 1)}`;

      const imagesContainer = document.getElementById('modalImagesContainer');
      imagesContainer.innerHTML = images.map((img, i) => `
        <img src="${img}" alt="${title}" class="modal-image ${i === 0 ? 'active' : ''}" loading="lazy"
          onload="document.querySelector('.modal-image-main').classList.add('loaded')"
          onerror="document.querySelector('.modal-image-main').classList.add('loaded')"
        />
      `).join('');

      document.querySelector('.modal-image-main').classList.remove('loaded');

      const thumbnails = document.getElementById('modalThumbnails');
      if (images.length > 1) {
        thumbnails.innerHTML = images.map((img, i) => `
          <img src="${img}" alt="${title}" class="modal-thumbnail ${i === 0 ? 'active' : ''}" onclick="setImage(${i})" />
        `).join('');
        thumbnails.style.display = 'flex';
      } else {
        thumbnails.style.display = 'none';
      }

      const details = [];

      if (currentProduct.author) {
        details.push({ label: '–ê–≤—Ç–æ—Ä', value: currentProduct.author });
      }
      if (currentProduct.category) {
        details.push({ label: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', value: currentProduct.category });
      }
      if (currentProduct.size) {
        details.push({ label: '–†–∞–∑–º–µ—Ä', value: currentProduct.size });
      }
      if (currentProduct.color) {
        details.push({ label: '–¶–≤–µ—Ç', value: currentProduct.color });
      }
      if (currentProduct.quantity !== undefined) {
        details.push({ label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', value: currentProduct.quantity });
      }

      document.getElementById('modalDetails').innerHTML = details.map(d => `
        <div class="detail-row">
          <div class="detail-label">${d.label}</div>
          <div class="detail-value">${d.value}</div>
        </div>
      `).join('');

      const description = currentProduct.description || currentProduct.material;
      document.getElementById('modalDescription').innerHTML = description ? `<div class="modal-section-title">–û–ø–∏—Å–∞–Ω–∏–µ</div><p>${description}</p>` : '';

      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function orderProduct() {
      const productName = currentProduct.title || currentProduct.name;
      const author = currentProduct.author;
      const price = currentProduct.discount && currentProduct.discount > 0
        ? Math.round(currentProduct.price * (1 - currentProduct.discount / 100))
        : currentProduct.price;
      const color = currentProduct.color;

      const message = `
        ${productName}
        ${color ? `–¶–≤–µ—Ç: ${color}` : ''}
        –ê–≤—Ç–æ—Ä: ${author}
        –¶–µ–Ω–∞: ${price}
      `;

      const phone = '79219095214';
      const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
      window.open(url, '_blank');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      document.body.style.overflow = '';
    }

    function changeImage(direction) {
      const images = document.querySelectorAll('.modal-image');
      const indicators = document.querySelectorAll('.indicator');

      if (images.length <= 1) return;

      images[currentImageIndex].classList.remove('active');
      if (indicators[currentImageIndex]) {
        indicators[currentImageIndex].classList.remove('active');
      }

      currentImageIndex = (currentImageIndex + direction + images.length) % images.length;

      images[currentImageIndex].classList.add('active');
      if (indicators[currentImageIndex]) {
        indicators[currentImageIndex].classList.add('active');
      }
    }

    function setImage(index) {
      const images = document.querySelectorAll('.modal-image');
      const thumbnails = document.querySelectorAll('.modal-thumbnail');

      images[currentImageIndex].classList.remove('active');
      if (thumbnails[currentImageIndex]) {
        thumbnails[currentImageIndex].classList.remove('active');
      }

      currentImageIndex = index;

      images[currentImageIndex].classList.add('active');
      if (thumbnails[currentImageIndex]) {
        thumbnails[currentImageIndex].classList.add('active');
      }
    }

    // Debounce –¥–ª—è –ø–æ–∏—Å–∫–∞
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(filterAndSort, 300);
    });

    document.getElementById('categoryFilter').addEventListener('change', filterAndSort);
    document.getElementById('authorFilter').addEventListener('change', filterAndSort);
    document.getElementById('priceMin').addEventListener('input', filterAndSort);
    document.getElementById('priceMax').addEventListener('input', filterAndSort);
    document.getElementById('sortSelect').addEventListener('change', filterAndSort);

    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target.id === 'modal') {
        closeModal();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (document.getElementById('modal').classList.contains('active')) {
        if (e.key === 'Escape') closeModal();
        if (e.key === 'ArrowLeft') changeImage(-1);
        if (e.key === 'ArrowRight') changeImage(1);
      }
    });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadProducts();
  </script>
</body>

</html>
